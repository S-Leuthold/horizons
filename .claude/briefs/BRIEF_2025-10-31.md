# Codebase Brief: horizons (feature-library-predictions branch)
**Generated**: 2026-01-15
**Branch**: feature/library-predictions (feature branch from main)
**Commit**: 49b0784

---

## TL;DR
R package for soil property prediction via MIR spectroscopy; dual-mode system (custom training + library-based prediction); currently implementing Phase 3 uncertainty quantification with residual-based intervals.

---

## Architecture

**Core Components** (45 R source files, 15,254 LOC):
- **Library Prediction System** (NEW): `R/library-*.R` (8 files, ~200KB) - OSSL/KSSL-based training-free prediction with GMM clustering, auto-optimization, ILR texture transforms, residual-based UQ
- **Custom Evaluation System** (STABLE): `R/evaluation-*.R` (5 files, ~210KB) - Local/HPC backends, parallel CV, ensemble stacking, memory optimization
- **Covariate Integration**: `R/covariates-*.R` (7 files, ~180KB) - Soil, climate, terrain prediction from spectra using OSSL
- **Feature Engineering**: `R/feature-*.R`, `R/transform-*.R` (4 files) - PCA, CARS, Boruta, correlation filtering, spectral transforms
- **Infrastructure**: `R/utils-*.R`, `R/inputs-*.R`, `R/models-*.R`, `R/metrics-*.R` (18 files) - Parallel backends, error handling, tidymodels recipes/specs, custom metrics (RPD, CCC, RRMSE)

**Key Dependencies**: tidymodels ecosystem (workflows, recipes, tune, rsample, parsnip), mclust (GMM), ranger (quantile regression), compositions (ILR), cli (tree-style output), butcher (memory), 57 total imports

**Test Suite**: 82 test files, 189 library tests passing, 80.22% package-wide coverage (main branch), 6 test-library-*.R files for new feature

---

## Current Capabilities

**Production-Ready (Main Branch)**:
- Custom model training for novel properties via `evaluate_models_local/hpc()` with 9 algorithms (RF, cubist, xgboost, PLSR, etc.)
- Ensemble stacking, weighted averaging, nested parallelization (doMC Linux, future macOS)
- Spectral preprocessing (SNV, MSC, SG derivatives), response transforms (log, Box-Cox)
- Memory-optimized workflows (butcher, streaming, aggressive rm/gc)

**In Development (Feature Branch)**:
- Library-based prediction API (`predict_library()`) - no training data required for 15 standard properties
- GMM clustering (BIC-optimal K, Ledoit-Wolf shrinkage) - assigns unknowns to OSSL subpopulations
- Auto-optimization per cluster - tests property-specific configs, selects winner by composite score
- ILR texture transformation - trains 2 models (ilr_1/ilr_2) instead of 3, guarantees mass balance
- **Residual-based UQ** (M3.1 COMPLETE) - trains ranger quantiles on point model residuals (OOF CV), 90.2% coverage achieved

---

## Active Development

**Phase 3 - Uncertainty Quantification** (Week 5-7, M3.1/M3.2 done, M3.3 in progress):
- âœ… **M3.1 Residual-Based UQ**: `R/library-uq.R` (38KB, 8 functions) implements `train_cluster_models_with_uq()`, `predict_with_uq()`, `predict_quantiles()`, `repair_quantile_crossings()` - fixed critical OOF bias bug (26Ã— impact on interval width)
- âœ… **M3.2 Heteroscedasticity Validation**: Spike tests confirmed quantile models needed (p<0.05 across pH, OC, total_carbon)
- ðŸš§ **M3.3 Conformal Calibration** (INCOMPLETE): Infrastructure in place (`compute_conformal_margin()`, c_alpha integration) but needs OOF quantile extraction via shared CV folds - detailed spec in `M3.3_CONFORMAL_IMPLEMENTATION_SPEC.md`
- ðŸ“‹ **Recent Commits**: f38581b (Session 6 cleanup), 7ce50e9 (residual-based implementation), 2c7fc4c (texture g/kg fix)

**Validation Results** (from commit messages):
- Full OSSL pH test: 90.2% coverage (perfect without conformal!), mean width 1.43 pH (37% narrower than library-based 2.29 pH), OOF residual SD=0.487 matches test error SD=0.63

**Roadmap Status**: `LIBRARY_PREDICTION_ROADMAP.md` (1,212 lines) tracks 4 phases over 10-12 weeks; Phase 1 (6/6 milestones) COMPLETE, Phase 2 deferred, Phase 3 (M3.1+M3.2 done)

---

## Gaps / Risks

**Technical Debt**:
- PLSR upstream bug fixed via fork (tidymodels/plsmod#47), pending merge - using `S-Leuthold/plsmod-fork` in DESCRIPTION Remotes
- M3.3 conformal needs proper CV+ implementation (OOF quantiles currently in-sample, optimistic bias)
- Mixed error handling patterns (3-layer architecture defined but not fully applied) - documented in CLAUDE.md with TODO pattern
- 57 dependencies (target <30 for JOSS submission) - needs audit

**Coverage Gaps**:
- M3.3 incomplete (Session 6 identified OOF quantile issue, spec written, implementation pending)
- Phase 4 applicability domain + AD-gated library fallback not started (Weeks 8-10)
- Water band removal lever added but not default-on yet (Phase 2 polish deferred)

**Documentation**:
- R CMD check: 1 ERROR (examples), 6 WARNINGS (docs), 7 NOTES per CLAUDE.md
- JOSS submission pending (paper + vignettes + CMD check cleanup)

**Ownership**: 400/418 commits by Sam Leuthold (single developer)

---

## Questions for You

1. **M3.3 Strategy**: Proceed with CV+ conformal using shared folds (per spec) or validate 90.2% coverage holds across other properties first?
2. **Phase Sequencing**: Continue Phase 3 UQ (M3.3â†’M3.4) or pivot to Phase 2 polish (water bands, RPIQ composite scoring)?
3. **Texture Testing**: Current validation used pH; should we validate ILR residuals on texture properties before proceeding?
4. **Conformal Necessity**: 90.2% pH coverage without conformal suggests residual quantiles well-calibrated - still worth belt-and-suspenders?
5. **Test Coverage Goal**: Maintain 80% or push higher for new UQ functions (currently 24 prediction tests)?
6. **Memory Discipline**: Any concerns with UQ training 3 models/cluster (point + q05 + q95) vs current 1 model?
7. **Pinball Loss**: M3.3 spec includes optional tuning of quantile loss alpha - priority or defer?

---

## Sources

**CLAUDE Context (3 layers)**:
- Global: `~/.claude/CLAUDE.md` (3 lines) - detailed plans, no commit signing, periodic status updates
- Project: `CLAUDE.md` (689 lines) - R style guide (arrow operators, tree-style CLI, aggressive alignment), Session 6 progress (M3.1 complete, OOF bug fixed, M3.3 spec written), collaboration pattern (section-by-section, Sam=PM+Senior Dev, Claude=executor)
- Worktree: None found

**Roadmap**: `LIBRARY_PREDICTION_ROADMAP.md` (read 100/1,212 lines) - comprehensive 4-phase plan with ADRs, Phase 1 COMPLETE (6/6 milestones), Phase 3 active

**Commits Scanned**: 30 commits from f38581b back to 3e0ec1a (7 days), key SHAs inspected: f38581b (conformal infrastructure), 7ce50e9 (residual-based UQ), 475a49c (Phase 1 handoff)

**Map Build**: Manual (Explore agent unavailable), analyzed 45 R files, 82 tests, DESCRIPTION (57 imports, custom plsmod fork), library-uq.R (38KB, quantile functions), library-orchestrator.R (predict_library API)

---

## Metadata
- **Repository**: horizons R package v0.9.0
- **Branch**: uncertainty-quantification (feature branch)
- **Files**: 419 tracked (45 R sources, 82 tests)
- **Coverage**: 80.22% (main branch, JOSS-ready)
- **Last Updated**: 2025-10-31
- **Worktree**: /Users/samleuthold/Desktop/_brain/1_Current_Projects/horizons/worktrees/feature-library-predictions
