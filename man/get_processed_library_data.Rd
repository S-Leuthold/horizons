% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/library-data.R
\name{get_processed_library_data}
\alias{get_processed_library_data}
\title{Load and Process Spectral Library Data}
\usage{
get_processed_library_data(
  property,
  variance_threshold = 0.99,
  remove_water_bands = FALSE,
  water_regions = list(c(3600, 3000), c(1650, 1600)),
  max_samples = NULL,
  cache_dir = NULL,
  verbose = TRUE
)
}
\arguments{
\item{property}{Character. Property name from LIBRARY_PROPERTIES}

\item{variance_threshold}{Numeric. Cumulative variance to retain in PCA (0-1). Default: 0.99}

\item{remove_water_bands}{Logical. Remove H2O interference regions? Default: FALSE.
Experimental feature - validate impact before production use.}

\item{water_regions}{List. Wavenumber ranges to remove if remove_water_bands = TRUE.
Default: list(c(3600, 3000), c(1650, 1600))}

\item{max_samples}{Integer. Maximum samples to load (for testing). Default: NULL (all).}

\item{cache_dir}{Character. Cache directory for OSSL downloads. Default: NULL (user dir).}

\item{verbose}{Logical. Print tree-style progress messages? Default: TRUE}
}
\value{
A list with components:
\describe{
\item{library_data}{Tibble with preprocessed spectral data and property measurements}
\item{pca_model}{PCA transformation object for projecting new samples}
\item{pca_scores}{Matrix of PCA scores for library samples}
\item{n_components}{Integer, number of PCA components retained}
\item{n_samples}{Integer, number of library samples}
\item{property}{Character, property name}
\item{variance_explained}{Numeric, cumulative variance in retained components}
}
Returns NULL if any stage fails.
}
\description{
Loads reference spectral library data (OSSL/KSSL) for a given soil property,
applies method harmonization, preprocessing, and PCA transformation. This is the
primary data preparation function for library-based prediction mode.
}
\details{
The function executes the following pipeline:
\enumerate{
\item Load raw OSSL data for the specified property
\item Preprocess MIR spectra (optional water band removal + SNV)
\item Perform PCA to create clustering space
\item Clean up memory after each stage
}

All intermediate objects are aggressively cleaned to maintain <500MB overhead.

Clustering space uses minimal preprocessing (SNV only) to preserve flexibility.
Model-specific preprocessing (derivatives, etc.) happens during training.
}
\section{Memory Management}{

The function uses aggressive cleanup:
\itemize{
\item rm() + gc() after raw loading
\item rm() + gc() after preprocessing
\item rm() + gc() after PCA
Target: <500MB overhead regardless of library size
}
}

\examples{
\dontrun{
# Load and process clay data
clay_lib <- get_processed_library_data("clay")

# With custom settings
oc_lib <- get_processed_library_data(
  property = "oc",
  variance_threshold = 0.95,
  remove_water_bands = TRUE,
  verbose = TRUE
)
}

}
\keyword{internal}
