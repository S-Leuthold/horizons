% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/covariates-soil-download_ossl.R
\name{download_ossl_data}
\alias{download_ossl_data}
\title{Download and Preprocess OSSL Spectral and Covariate Data}
\usage{
download_ossl_data(
  covariates,
  window_size = 9,
  max_samples = NULL,
  parallel = FALSE,
  n_workers = NULL,
  allow_nested = FALSE
)
}
\arguments{
\item{covariates}{A character vector of covariate names to retrieve (e.g., \code{"Sand"}, \code{"pH"}, \code{"SOC"}).
Covariate names must match those defined in the internal OSSL variable dictionary.}

\item{window_size}{Integer. Width of the Savitzky-Golay smoothing window (must be odd). Defaults to \code{9}.}

\item{max_samples}{Optional integer. If supplied, limits the number of samples processed—useful for debugging or testing.
If \code{NULL}, all available samples are used.}

\item{parallel}{Logical. Enable parallel processing for spectral preprocessing. Defaults to \code{FALSE} (safe for nested contexts).}

\item{n_workers}{Integer. Number of parallel workers. If \code{NULL}, uses \code{min(10, detectCores()-1)} for safety.}

\item{allow_nested}{Logical. Allow parallel processing even when already in parallel context. Defaults to \code{FALSE} (recommended).}

\item{bounding_box}{Currently unused. Placeholder for future spatial subsetting based on bounding box coordinates.}
}
\value{
A \code{tibble} containing:
\itemize{
\item Preprocessed MIR spectra: SNV-SG0 transformed reflectance values at 2 cm⁻¹ resolution between 600–4000 cm⁻¹.
\item Covariate data: Wide-format table of measured values for requested soil properties.
\item Sample index: A sequential index column for internal referencing.
}
}
\description{
Retrieves topsoil mid-infrared (MIR) spectral data and associated covariate measurements
from the Open Soil Spectroscopy Library (OSSL). Applies Savitzky-Golay smoothing followed by
standard normal variate (SNV) preprocessing to the spectra, reshapes and filters lab data,
and joins all components into a unified dataset. Final outputs are cached for reuse.
}
\details{
This function follows a multi-step pipeline:
\enumerate{
\item Read and filter the internal OSSL variable dictionary.
\item Load cached raw data files (location, lab, and MIR) from disk using \code{qs::qread()}.
\item Filter and reshape metadata to include only topsoil layers and desired covariates.
\item Load and optionally subsample MIR spectra.
\item Apply parallelized SNV and Savitzky-Golay preprocessing via \code{furrr::future_map()}.
\item Cache the resulting processed spectra using \code{qs::qsave()} for future reuse.
\item Join processed spectra with lab data by \code{Layer_ID}.
}

If previously processed MIR spectra exist in cache, they are loaded automatically to avoid reprocessing.
Progress and errors are communicated through \code{cli}-based messaging and \code{safely_execute()} wrappers.
}
\examples{
\dontrun{
# Download and preprocess OSSL data for pH and Sand
ossl_data <- download_ossl_data(covariates = c("pH", "Sand"))

# Preview structure
glimpse(ossl_data)
}

}
\seealso{
\code{\link{predict_covariates}}, \code{\link{create_input_data}}
}
