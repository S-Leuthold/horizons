% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/library-uq.R
\name{train_cluster_models_with_uq}
\alias{train_cluster_models_with_uq}
\title{Train Point and Quantile Models for a Cluster}
\usage{
train_cluster_models_with_uq(
  cluster_data,
  property,
  config,
  cv_folds = 10,
  grid_size = 10,
  verbose = FALSE
)
}
\arguments{
\item{cluster_data}{Tibble with cluster training data. Must contain:
\itemize{
\item \code{Response} column (target variable or ILR coordinate)
\item \code{Sample_ID} column
\item \code{Project} column
\item Spectral columns (numeric wavenumbers)
}}

\item{property}{Character. Property name (e.g., "clay", "ph", "oc").
Used for metadata tracking only.}

\item{config}{Tibble (1 row) with optimal configuration:
\itemize{
\item \code{model}: Model type for point prediction
\item \code{preprocessing}: Spectral preprocessing method
\item \code{transformation}: Response transformation
\item \code{feature_selection}: Feature selection method
}}

\item{cv_folds}{Integer. Number of cross-validation folds (default: 10).}

\item{grid_size}{Integer. Number of hyperparameter grid points (default: 10).}

\item{verbose}{Logical. Print progress messages?}
}
\value{
A list with components:
\itemize{
\item \code{point_model}: Fitted workflow for point predictions (best config)
\item \code{quantile_model}: Fitted workflow for quantile predictions (ranger)
\item \code{point_metrics}: Performance metrics for point model
\item \code{config_used}: Configuration used for point model
\item \code{property}: Property name
\item \code{n_train}: Number of training samples
\item \code{is_residual_based}: Logical flag (always TRUE)
\item \code{residual_stats}: List with mean and SD of training residuals
\item \code{c_alpha}: Conformal calibration margin for 90\% coverage
\item \code{ad_metadata}: Applicability domain metadata (centroid, covariance, thresholds); NULL if computation failed
}
}
\description{
Trains both point prediction and quantile regression models for a single
cluster in the library prediction workflow. Implements the decoupled UQ
architecture where point predictions come from the best-performing model
(as determined by config optimization) and uncertainty quantification always
uses ranger quantile regression.
}
\details{
\subsection{Training Strategy}{

This function trains TWO models sequentially:
\enumerate{
\item \strong{Point Prediction Model} (using optimal config):
\itemize{
\item Model type from config (cubist, PLSR, xgboost, etc.)
\item Full hyperparameter tuning with cross-validation
\item Evaluated on held-out samples
}
\item \strong{Quantile Model} (always ranger):
\itemize{
\item Ranger with \code{quantreg = TRUE}
\item Uses SAME preprocessing/transformation as point model
\item Feature selection: none (ranger handles feature importance internally)
\item Predicts q05 and q95 at prediction time
}
}
}

\subsection{Memory Management}{

After training each model:
\itemize{
\item Apply \code{butcher::butcher()} to reduce workflow size (60-80\% reduction)
\item Remove intermediate objects
\item Call \code{gc()} to free memory
}
}

\subsection{For Texture Properties}{

When called for texture ILR coordinates (ilr_1, ilr_2):
\itemize{
\item This function is called TWICE (once per coordinate)
\item Total: 4 models per cluster (2 coords Ã— 2 model types)
\item Back-transformation happens at prediction time (not here)
}
}
}
\examples{
\dontrun{
# Train models for pH prediction
models <- train_cluster_models_with_uq(
  cluster_data = cluster_1_data,
  property = "ph",
  config = winning_config,
  cv_folds = 10,
  grid_size = 10
)

# Use for prediction
point_pred <- predict(models$point_model, new_data)
quantiles <- predict_quantiles(models$quantile_model, new_data)
}

}
\seealso{
\code{\link[=train_and_score_config]{train_and_score_config()}} for underlying training logic,
\code{\link[=define_model_specifications]{define_model_specifications()}} for point models,
\code{\link[=define_quantile_specification]{define_quantile_specification()}} for quantile models
}
\keyword{internal}
