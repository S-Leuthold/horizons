% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/library-uq.R
\name{calculate_pinball_loss}
\alias{calculate_pinball_loss}
\title{Calculate Pinball Loss for Quantile Predictions}
\usage{
calculate_pinball_loss(
  truth,
  pred_lower,
  pred_upper,
  tau_lower = 0.05,
  tau_upper = 0.95
)
}
\arguments{
\item{truth}{Numeric vector of true values.}

\item{pred_lower}{Numeric vector of lower quantile predictions (e.g., q05).}

\item{pred_upper}{Numeric vector of upper quantile predictions (e.g., q95).}

\item{tau_lower}{Numeric. Lower quantile level (default: 0.05).}

\item{tau_upper}{Numeric. Upper quantile level (default: 0.95).}
}
\value{
Numeric scalar: mean pinball loss averaged across both quantiles.
}
\description{
Computes pinball loss (quantile loss) for evaluating quantile regression
predictions. This is the theoretically correct loss function for quantile
models, providing asymmetric penalties that align with the quantile objective.
}
\details{
\subsection{Pinball Loss Formula}{

For a single quantile prediction at level tau:

\if{html}{\out{<div class="sourceCode">}}\preformatted{error = truth - prediction
loss  = max(tau * error, (tau - 1) * error)
}\if{html}{\out{</div>}}

This creates an asymmetric penalty:
\itemize{
\item For q05 (tau=0.05): Over-prediction penalized 19× more than under-prediction
\item For q95 (tau=0.95): Under-prediction penalized 19× more than over-prediction
}
}

\subsection{Why Pinball Loss?}{

\strong{RMSE (wrong)}: Optimizes for conditional mean
\itemize{
\item Treats over/under-prediction symmetrically
\item Pushes quantiles toward mean(residuals) ≈ 0
\item Not aligned with quantile objective
}

\strong{Pinball Loss (correct)}: Optimizes for conditional quantiles
\itemize{
\item Asymmetric penalties guide predictions to true quantile locations
\item For residuals: q05 ≈ -1.2, q95 ≈ +1.2 (not both → 0)
\item Better conditional coverage across feature space
}
}

\subsection{Multi-Quantile Tuning}{

This function averages pinball loss across q05 and q95 to produce a single
optimization objective for \code{tune_grid()} or custom tuning loops. This ensures:
\itemize{
\item Both quantiles optimized simultaneously
\item No quantile crossing (same model produces both)
\item Single set of optimal hyperparameters
}
}
}
\examples{
\dontrun{
# True residuals
truth <- c(-1.5, -0.5, 0.2, 1.0, 2.1)

# Quantile predictions
pred_lower <- c(-1.8, -0.7, -0.1, 0.8, 1.9)  # q05
pred_upper <- c(1.2, 1.5, 1.8, 2.2, 3.5)     # q95

# Calculate average pinball loss
loss <- calculate_pinball_loss(truth, pred_lower, pred_upper)

# Lower loss = better quantile predictions
}

}
\seealso{
\code{\link[=train_quantile_model]{train_quantile_model()}} for quantile model tuning,
\code{\link[=extract_oof_quantiles]{extract_oof_quantiles()}} for obtaining OOF predictions
}
\keyword{internal}
