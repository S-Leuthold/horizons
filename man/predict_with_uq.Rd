% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/library-uq.R
\name{predict_with_uq}
\alias{predict_with_uq}
\title{Predict with Uncertainty Quantification (Residual-Based)}
\usage{
predict_with_uq(
  point_workflow,
  quantile_workflow,
  new_data,
  quantiles = c(0.05, 0.95),
  c_alpha = 0,
  repair_crossings = TRUE
)
}
\arguments{
\item{point_workflow}{Fitted workflow object for point predictions.
Can be ANY model type (cubist, PLSR, xgboost, etc.).}

\item{quantile_workflow}{Fitted workflow object for residual quantile predictions.
Must be a ranger model trained on point model residuals using
\code{\link[=train_cluster_models_with_uq]{train_cluster_models_with_uq()}}.}

\item{new_data}{Data frame or tibble containing new samples to predict.
Must have same predictor structure as training data.}

\item{quantiles}{Numeric vector of length 2 specifying quantile levels.
Default: \code{c(0.05, 0.95)} for 90\% prediction intervals.}

\item{repair_crossings}{Logical. Should quantile crossings be repaired?
Default: TRUE. Enforces \code{.pred_lower <= .pred_upper}.}
}
\value{
A tibble with one row per sample in \code{new_data} and columns:
\itemize{
\item \code{.pred}: Point prediction from best model
\item \code{.pred_lower}: Lower prediction bound (point + residual_q05)
\item \code{.pred_upper}: Upper prediction bound (point + residual_q95)
}
}
\description{
Generates point predictions and prediction intervals using the residual-based
UQ approach. This function combines point predictions from the best-performing
model with residual quantiles from ranger to construct prediction intervals
that reflect model-specific uncertainty.
}
\details{
\subsection{Residual-Based Approach}{

This function implements the residual-based UQ workflow:
\enumerate{
\item \strong{Get point prediction}: \code{y_hat = f_point(X)}
\item \strong{Get residual quantiles}: \verb{[r_q05, r_q95] = f_quantile(X)}
\item \strong{Construct intervals}: \verb{[y_hat + r_q05, y_hat + r_q95]}
}

Note: \code{r_q05} is typically NEGATIVE (5th percentile of residuals),
\code{r_q95} is typically POSITIVE (95th percentile of residuals)
}

\subsection{Why Residual-Based?}{

\strong{Library-based} (alternative): Trains quantile model on Response values
\itemize{
\item Intervals reflect population variability in reference library
\item Wide intervals (e.g., pH: 2.6 units)
\item Interpretation: "Range of values in library for this spectral type"
}

\strong{Residual-based} (this approach): Trains quantile model on model residuals
\itemize{
\item Intervals reflect MODEL confidence in THIS prediction
\item Narrow intervals (e.g., pH: 0.9 units, 65\% reduction)
\item Interpretation: "90\% confident YOUR sample is in this range"
\item Better point models → smaller residuals → narrower intervals
}
}

\subsection{Conformal Calibration}{

These intervals are "uncalibrated" - they achieve ~85-95\% empirical coverage.
Apply conformal calibration (M3.3) to adjust intervals to exactly 90\% coverage:

\if{html}{\out{<div class="sourceCode r">}}\preformatted{c_alpha <- compute_conformal_margin(models, calibration_data)
final_interval <- [pred_lower - c_alpha, pred_upper + c_alpha]
}\if{html}{\out{</div>}}
}

\subsection{Texture Properties}{

For texture properties (sand, silt, clay):
\itemize{
\item This function called TWICE (once per ILR coordinate)
\item Residuals computed in ILR space: ilr_1_residuals, ilr_2_residuals
\item Back-transformation to texture space happens AFTER adding residual quantiles
\item Point predictions sum to 100\%, intervals are marginal (don't guarantee sum=100\%)
}
}
}
\examples{
\dontrun{
# Train models with residual-based UQ
models <- train_cluster_models_with_uq(
  cluster_data = train_data,
  property = "ph",
  config = winning_config
)

# Predict with UQ
predictions <- predict_with_uq(
  point_workflow = models$point_model,
  quantile_workflow = models$quantile_model,
  new_data = test_samples
)

# Result: .pred, .pred_lower, .pred_upper
head(predictions)
}

}
\seealso{
\code{\link[=train_cluster_models_with_uq]{train_cluster_models_with_uq()}} for training residual-based models,
\code{\link[=predict_quantiles]{predict_quantiles()}} for extracting quantiles,
\code{\link[=repair_quantile_crossings]{repair_quantile_crossings()}} for monotonicity enforcement
}
\keyword{internal}
