% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/library-uq.R
\name{extract_oof_quantiles}
\alias{extract_oof_quantiles}
\title{Extract Out-of-Fold Quantile Predictions}
\usage{
extract_oof_quantiles(
  workflow,
  train_data,
  resamples,
  quantiles = c(0.05, 0.95)
)
}
\arguments{
\item{workflow}{A finalized workflow object (not tuned, must have fixed hyperparameters).
Should contain a ranger quantile model created with \code{\link[=define_quantile_specification]{define_quantile_specification()}}.}

\item{train_data}{Tibble with training data. Must have \code{Response} column.
For residual-based UQ, this should have residuals as Response.}

\item{resamples}{An \code{rset} object from rsample (e.g., from \code{vfold_cv()}).
Must use the SAME folds as the point model for proper alignment.}

\item{quantiles}{Numeric vector of quantiles to extract (default: c(0.05, 0.95)).}
}
\value{
Tibble with out-of-fold quantile predictions:
\itemize{
\item \code{.row}: Original row indices from train_data
\item \code{.pred_lower}: Lower quantile (q05)
\item \code{.pred_upper}: Upper quantile (q95)
\item Additional columns for other quantiles if requested
}
}
\description{
Helper function that extracts out-of-fold quantile predictions by looping
through CV folds. Used for both pinball loss re-ranking and conformal
calibration. Ensures predictions are truly OOF (not in-sample).
}
\details{
\subsection{How It Works}{

For each CV fold:
\enumerate{
\item Extract fold indices using \code{rsample::complement()}
\item Get training subset (analysis) and assessment subset
\item Fit finalized workflow on training subset
\item Predict quantiles on assessment subset (OOF!)
\item Track \code{.row} indices for alignment with point model predictions
}

The result contains predictions for ALL samples in train_data, where each
sample's prediction comes from a model that did NOT see that sample during
training (true out-of-fold).
}

\subsection{Use Cases}{
\enumerate{
\item \strong{Pinball Loss Re-Ranking}: Extract OOF quantiles for each candidate
hyperparameter configuration to calculate validation loss
\item \strong{Conformal Calibration}: Extract OOF quantiles from final model to
compute conformal margin with matched point predictions
}
}
}
\seealso{
\code{\link[=predict_quantiles]{predict_quantiles()}} for extracting quantiles from a single model,
\code{\link[=calculate_pinball_loss]{calculate_pinball_loss()}} for evaluating quantile quality,
\code{\link[=train_quantile_model]{train_quantile_model()}} where this helper is used
}
\keyword{internal}
