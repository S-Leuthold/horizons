% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/library-data.R
\name{preprocess_library_spectra}
\alias{preprocess_library_spectra}
\title{Preprocess Library MIR Spectra for Clustering}
\usage{
preprocess_library_spectra(
  spectral_data,
  remove_water_bands = FALSE,
  water_regions = list(c(3600, 3000), c(1650, 1600)),
  verbose = TRUE
)
}
\arguments{
\item{spectral_data}{Data frame or tibble with spectral columns (X\if{html}{\out{<wavenumber>}} format).
Non-spectral columns (sample_id, property values) are preserved.}

\item{remove_water_bands}{Logical. Remove H2O interference regions? Default: FALSE.
\strong{Experimental} - validate impact on cluster quality before production use.
From spectroscopy expert review: May improve clustering, test empirically.}

\item{water_regions}{List of numeric vectors. Wavenumber ranges \link{high, low} to exclude.
Default: list(c(3600, 3000), c(1650, 1600)) cm⁻¹.
Only used if remove_water_bands = TRUE.}

\item{verbose}{Logical. Print tree-style progress? Default: TRUE.}
}
\value{
Tibble with:
\itemize{
\item SNV-transformed spectral columns (X\if{html}{\out{<wavenumber>}})
\item Water bands removed if enabled (fewer columns)
\item Non-spectral columns preserved
}

Returns NULL if preprocessing fails.
}
\description{
Applies Standard Normal Variate (SNV) transformation to library spectra for
clustering space preparation. Optionally removes water interference bands.
This preprocessing creates the stable clustering space - model-specific
preprocessing (derivatives, baseline correction) happens separately during training.
}
\details{
\strong{Preprocessing Pipeline:}
\enumerate{
\item Identify spectral columns (X\if{html}{\out{<wavenumber>}} format)
\item Remove water interference bands (optional, experimental)
\itemize{
\item Default regions: 3600-3000 cm⁻¹, 1650-1600 cm⁻¹
\item These are H2O absorption bands that mask soil signals
}
\item Apply SNV transformation (always)
\itemize{
\item Normalize each spectrum to mean=0, sd=1
\item Removes multiplicative scatter, preserves spectral shape
}
\item Reconstruct tibble with non-spectral columns preserved
}

\strong{Design Rationale:}
Clustering uses minimal preprocessing (SNV only) to create stable, interpretable
clusters based on fundamental spectral patterns. More aggressive preprocessing
(derivatives, baseline correction) is applied per-model during training to allow
flexibility in model configurations.

\strong{Edge Case Handling:}
\itemize{
\item Zero-variance spectra: SNV produces NaN → replaced with 0
\item Single samples: Handled gracefully
\item Missing spectral columns: Returns NULL with warning
}
}
\section{Performance}{

\itemize{
\item ~1-2 seconds for 500 samples
\item ~10-20 seconds for 12K samples (full OSSL)
\item Memory: <100MB overhead
}
}

\examples{
\dontrun{
# Basic preprocessing (SNV only)
preprocessed <- horizons:::preprocess_library_spectra(raw_spectra)

# With water band removal (experimental)
preprocessed <- horizons:::preprocess_library_spectra(
  raw_spectra,
  remove_water_bands = TRUE,
  verbose = TRUE
)
}

}
\seealso{
\code{\link[=load_ossl_raw]{load_ossl_raw()}}, \code{\link[=perform_pca_on_library]{perform_pca_on_library()}}
}
\keyword{internal}
