% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pipeline-average.R
\name{average}
\alias{average}
\title{Average replicate spectra with quality control}
\usage{
average(
  x,
  by = "sample_id",
  quality_check = TRUE,
  correlation_threshold = 0.996,
  on_all_outliers = c("warn", "drop", "keep_best"),
  verbose = TRUE
)
}
\arguments{
\item{x}{A \code{horizons_data} object from the pipeline.}

\item{by}{Character. Column name to group replicates by. Default: \code{"sample_id"}.}

\item{quality_check}{Logical. Enable correlation-based outlier detection.
Default: \code{TRUE}.}

\item{correlation_threshold}{Numeric. Minimum mean pairwise correlation for
a replicate to pass QC. Default: \code{0.996}. Changing this is rarely needed.}

\item{on_all_outliers}{Character. Behavior when all replicates fail QC:
\itemize{
\item \code{"warn"} (default): Keep all replicates and average
\item \code{"drop"}: Remove the sample entirely
\item \code{"keep_best"}: Keep only the replicate with highest mean correlation
}}

\item{verbose}{Logical. Print progress messages. Default: \code{TRUE}.}
}
\value{
The input \code{horizons_data} object with:
\itemize{
\item \code{data$analysis}: One row per unique value in \code{by} column
\item Predictor columns: Mean of replicate values
\item Metadata columns: Uniform values preserved, non-uniform dropped
\item \code{data$role_map}: Updated to remove dropped columns
\item \code{provenance$average}: Processing metadata including QC results
}
}
\description{
Aggregates replicate spectra by grouping column (default: \code{sample_id}) with
optional correlation-based quality control to detect and handle outliers.
}
\details{
\strong{Quality Control:}
When \code{quality_check = TRUE}, outliers are identified via iterative removal:
\enumerate{
\item Compute mean pairwise correlation for each replicate
\item Remove the replicate with lowest mean correlation
\item Recompute correlations for remaining replicates
\item Repeat until all remaining replicates pass threshold (or only 1 remains)
}

This iterative approach prevents a single bad replicate from dragging all
others below threshold, which can happen with the simpler "flag all at once"
method when group sizes are small (n=2-3).

\strong{Important:} Run \code{standardize()} with baseline correction before \code{average()}
to ensure baseline shifts don't confound quality control. Spectra with baseline
offsets can correlate ~1.0 but shouldn't be averaged without correction.

\strong{Handling All-Outlier Groups:}
If QC flags all replicates as outliers:
\itemize{
\item \code{"warn"} (default): Keep all replicates and average, emit warning
\item \code{"drop"}: Remove the entire sample from results
\item \code{"keep_best"}: Keep only the replicate with highest mean correlation
}

\strong{Metadata Handling:}
Metadata columns are checked for uniformity within groups:
\itemize{
\item Uniform values: preserved in output
\item Non-uniform values: column dropped (tracked in provenance)
\item \code{filename} column: always dropped (not meaningful after averaging)
}
}
\examples{
\dontrun{
# Basic averaging after parsing IDs
hd |>
  standardize() |>
  parse_ids(format = "{sample}_{rep}") |>
  average()

# Without quality control
hd |> average(quality_check = FALSE)

# Drop samples where all replicates are outliers
hd |> average(on_all_outliers = "drop")
}

}
