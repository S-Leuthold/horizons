# Function Audit Table
_Updated May 28 2025_

| Function Name                  | File Name                         | Purpose                                                                                                                  | Depends On                                  | Contributes To                                      | Exported | TODOs                                                                                                     |
|--------------------------------|-----------------------------------|--------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|-----------------------------------------------------|----------|-----------------------------------------------------------------------------------------------------------|
| `cluster_input_data`           | covar_cluster_input.R             | Cluster input spectra using PCA and k-means to group similar samples.                                                    | FactoMineR, dplyr                           | `predict_covariates`                                |    ❌    | Parameterize cluster cap; add tests for silhouette-based cluster selection.                               | 
| `create_training_subsets`      | covar_create_training_subsets.R   | Create training subsets by coverage threshold for each cluster.                                                          | dplyr, tidyr, recipes                       | `predict_covariates`                                |    ❌    | Add tests for edge cases (e.g., very small coverage threshold).                                           | 
| `evaluate_predictions`         | covar_evaluate_predictions.R      | Compute RMSE, R², CCC, RPIQ metrics for predictions.                                                                     | soilspec, yardstick                         | `predict_covariates`, `cubist_model_function_covar` |    ✅    | Validate behavior with missing data and edge-case metrics.                                                | 
| `predict_covariates`           | covar_predict.R                   | Orchestrates full covariate prediction pipeline: preprocessing, clustering, modeling.                                    | All above (`cluster_input_data`, etc.)      | central pipeline                                    |    ✅    | Modularize: break into smaller functions; validate robustness of data handling.                           | 
| `reduce_dimensions_pca_covpred`| covar_reduce_pca.R                | Reduce dimensionality using PCA for both training and prediction data.                                                   | FactoMineR, dplyr                           | `predict_covariates`                                |    ❌    | Add explicit tests for dimension reduction and edge cases.                                                | 
| `cubist_model_function_covar`  | covar_train_model_cubist.R        | Build, tune, and evaluate Cubist models for covariate prediction.                                                        | Cubist, dplyr, tune                         | `predict_covariates`                                |    ❌    | Document tuning assumptions (e.g., iter = 2 default).                                                     | 
| `build_ensemble_stack`         | ensemble_build_model_stack.R      | Build final stacked ensemble using `stacks`.                                                                             | stacks, workflows, tune                     | final predictions                                   |    ✅    | Add explicit tests for stacking with partial workflows; document assumptions.                             | 
| `create_input_data`            | input_create_raw.R                | Prepare input data by merging spectral and covariate data into a clean format.                                           | dplyr, readr                                | `predict_covariates`, data prep                     |    ✅    | Modularize read vs process; robust error handling for missing files.                                      | 
| `download_ossl_data`           | input_download_ossl.R             | Download external covariate data from the OSSL repository.                                                               | qs, cli, dplyr                              | `predict_covariates`                                |    ❌    | Implement bounding box support; test download error handling.                                             | 
| `get_file_location`            | input_get_file_locations.R        | Identify file paths for OPUS spectra.                                                                                    | base R                                      | `create_input_data`, `read_spectral_data`           |    ❌    | A                                                                                                         | 
| `join_physicochemical_data`    | input_join_physchem_data.R        | Merge physicochemical covariate data with input data.                                                                    | dplyr, readr                                | `create_input_data`                                 |    ❌    | Remove `suppressMessages`; add explicit warnings for parsing issues.                                      | 
| `read_spectral_data`           | input_read_opus_spectra.R         | Read and process OPUS files containing MIR spectral data.                                                                | readr, dplyr, stringr                       | `create_input_data`                                 |    ❌    | Validate filename parsing assumptions; robust handling of read errors.                                    | 
| `transform_outcome`            | input_transform_response.R        | Apply transformation (e.g., log, sqrt) to the outcome variable for compatibility with modeling workflows.                | dplyr, cli                                  | `full_model_evaluation`                             |    ✅    | Re-evaluate if recipes can handle outcome transformation; improve modularity.                             | 
| `rrmse_vec`                    | metric_rrmse.R                    | Custom metric: relative RMSE as a percentage of observed mean.                                                           | yardstick, dplyr, purrr                     | model evaluation                                    |    ✅    | Validate edge cases (e.g., all NAs in truth, zero variance).                                              | 
| `backtransform_tune_results`   | model_backtransform_tune_results.R| Inverse transform predictions in `tune_results` objects.                                                                 | dplyr, tune, workflows                      | final prediction output                             |    ❌    | Modularize back-transform logic; test across transformation types.                                        | 
| `build_model_grid`             | model_build_grid.R                | Create grid of model configurations and associated recipes.                                                              | dplyr, tidyr                                | `full_model_evaluation`                             |    ❌    | Move hard-coded model/transform lists to config; validate reproducibility of grid creation.               | 
| `build_recipe`                 | model_build_recipe.R              | Construct `recipes` for each workflow: transformation, preprocessing, covariate joins.                                   | recipes, dplyr, custom steps                | `full_model_evaluation`                             |    ❌    | Validate outcome transformation pipeline; test covariate join logic.                                      | 
| `define_model_specifications`  | model_define_specs.R              | Define parsnip model specifications (e.g., RF, Cubist, PLSR).                                                            | parsnip, workflows                          | `full_model_evaluation`                             |    ❌    | Move model definitions to external config or centralized helper; validate defaults.                       | 
| `evaluate_final_models`        | model_evaluate_holdout.R          | Evaluate tuned models on holdout data and compute metrics.                                                               | yardstick, dplyr                            | final results                                       |    ❌    | Modularize evaluation logic; handle missing metrics robustly.                                             | 
| `filter_workflows`             | model_filter_workflows.R          | Filter workflows based on performance metrics.                                                                           | dplyr, tune                                 | `full_model_evaluation`, stacking                   |    ❌    | Validate thresholds and quantile-based filtering; test with incomplete metrics.                           | 
| `clean_workflow_id`            | model_generate_workflow_ids.R     | Standardize workflow ID naming for tracking and evaluation.                                                              | dplyr                                       | `build_model_grid`, `full_model_evaluation`         |    ❌    | Document assumptions about abbreviation logic; ensure flexibility for future models.                      | 
| `run_bayesian_tuning`          | model_run_bayes_tuning.R          | Run Bayesian optimization on workflows.                                                                                  | tune, workflows, parsnip                    | `full_model_evaluation`                             |    ❌    | Modularize progress tracking; validate grid size and tuning iterations.                                   | 
| `full_model_evaluation`        | model_run_full_evaluation.R       | Orchestrate full evaluation pipeline: grid building, workflow creation, tuning, evaluation, stacking.                    | All above (central hub)                     | final predictions                                   |    ✅    | Modularize into smaller sub-functions; integrate reproducibility (seed tracking); improve logging.        | 
| `safe_tune_bayes`              | model_safe_tune_bayes.R           | Safely run Bayesian tuning with error handling.                                                                          | tune, workflows                             | `run_bayesian_tuning`                               |    ❌    | Generalize safe execution pattern; modularize for broader use.                                            | 
| `step_add_covariates`          | step_join_covariates.R            | `recipes` step to add covariates to input data during recipe processing.                                                 | recipes, dplyr                              | `build_recipe`                                      |    ✅    | Validate one ID assumption; test edge cases for join failures.                                            | 
| `step_add_covariates_new`      | step_join_covariates.R            | Constructor for the custom `recipes` step for covariate joining.                                                         | recipes                                     | `step_add_covariates`                               |    ✅    | Consolidate duplicate function definitions (currently appears twice).                                     | 
| `prep.step_add_covariates`     | step_join_covariates.R            | Prepares covariate join step at recipe prep stage.                                                                       | recipes, dplyr                              | `step_add_covariates`                               |    ❌    | Add robust error handling for missing columns/IDs; ensure reproducibility in joins.                       | 
| `bake.step_add_covariates`     | step_join_covariates.R            | Executes covariate join at prediction time.                                                                              | recipes, dplyr                              | `step_add_covariates`                               |    ❌    | Validate that prediction data aligns with training data IDs.                                              | 
| `print.step_add_covariates`    | step_join_covariates.R            | Print method for covariate join step.                                                                                    | recipes                                     | `step_add_covariates`                               |    ❌    | Harmonize print formatting across custom steps.                                                           | 
| `process_spectra`              | step_transform_spectra.R          | Preprocess spectra (SNV, Savitzky-Golay, derivative).                                                                    | prospectr, dplyr                            | `step_transform_spectra`                            |    ❌    | Consolidate repeated logic in `input_download_ossl.R` and `step_transform_spectra.R` into shared helper.  | 
| `step_transform_spectra`       | step_transform_spectra.R          | Custom `recipes` step to apply preprocessing pipeline to spectra.                                                        | recipes, dplyr, process_spectra             | `build_recipe`                                      |    ✅    | Validate robust handling of wavenumber ranges and failed preprocessing rows.                              | 
| `step_transform_spectra_new`   | step_transform_spectra.R          | Constructor for spectral transformation step in `recipes`.                                                               | recipes                                     | `step_transform_spectra`                            |    ✅    | Consolidate parameter definitions; ensure no duplicate constructor logic across files.                    | 
| `prep.step_transform_spectra`  | step_transform_spectra.R          | Prepares spectral transformation during recipe training.                                                                 | recipes, dplyr, process_spectra             | `step_transform_spectra`                            |    ❌    | Edge-case tests for partial data, trimming, derivative failures.                                          | 
| `bake.step_transform_spectra`  | step_transform_spectra.R          | Executes spectral transformation at prediction time.                                                                     | recipes, dplyr, process_spectra             | `step_transform_spectra`                            |    ❌    | Validate transformations align with recipe prep; document any limitations.                                | 
| `print.step_transform_spectra` | step_transform_spectra.R          | Print method for spectral transformation step.                                                                           | recipes                                     | `step_transform_spectra`                            |    ❌    | Harmonize print method style with `step_add_covariates`.                                                  | 
| `.onLoad`                      | zzz.R                             | Package startup hook: set cli progress delay and parallel processing plan.                                               | cli, future                                 | package-level setup                                 |    ❌    | Validate compatibility with user environment; ensure future parallel plan can be user-configurable.       | 
