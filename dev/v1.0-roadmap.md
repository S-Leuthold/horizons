# Horizons Package v1.0 Roadmap

## Overview
This document contains the consolidated recommendations from a comprehensive technical and structural review of the horizons R package (v0.7.5) conducted on 2025-08-22. The package shows solid architecture with 57 R source files and robust functionality, but requires several improvements before v1.0 release.

## Priority Classification
- **CRITICAL**: Must fix before v1.0 (blocks CRAN submission or causes runtime errors)
- **HIGH**: Should fix before v1.0 (professional package standards)
- **MEDIUM**: Nice to have for v1.0 (improves usability and maintenance)
- **LOW**: Can defer to post-v1.0 (minor improvements)

---

## CRITICAL Issues (1-2 days effort)

### 1. Remove Temporary Files (Immediate)
**Issue**: 11.7GB of temporary R data files in root directory
```bash
# Clean temporary files
rm -f .RDataTmp* .RData .Rhistory .DS_Store
rm -rf ..Rcheck
```

### 2. Fix SHAP Implementation Bug
**Location**: `R/step-feature_selection_shap.R:136-152`  
**Issue**: Function uses XGBoost variable importance instead of actual SHAP values  
**Fix**: Replace with proper SHAP implementation
```r
# Current (line 143-152): Uses xgboost::xgb.importance()
# Should use: SHAPforxgboost::shap.values() and shap.importance()
```

### 3. Fix Namespace Typo
**Location**: `R/model_build_recipe.R:74`  
**Issue**: `li::cli_alert_danger()` should be `cli::cli_alert_danger()`  
**Impact**: Runtime error when validation fails

### 4. Update .Rbuildignore
**Action**: Add development artifacts to .Rbuildignore
```
^scratch$
^dev$
^examples$
^experimental$
^archive$
^\.RDataTmp.*$
^\.RData$
^\.Rhistory$
^\.DS_Store$
^CLAUDE\.md$
^\.claude$
```

---

## HIGH Priority Issues (3-5 days effort)

### 1. Statistical Rigor Improvements

#### Cross-Validation Parameters
- **Current**: 3-fold CV in multiple locations
- **Required**: 5-10 folds minimum
- **Files to update**:
  - `covariates-soil-fit_cubist_model.R:114`
  - All other CV implementations

#### Holdout Set Size
- **Current**: 5% holdout (`covariates-soil-orchestrator.R:321`)
- **Required**: 15-20% holdout
- **Impact**: More reliable model evaluation

#### CARS Method Validation
- **Location**: `R/step-feature_selection_cars.R`
- **Action**: Add convergence checks and validation
- **Documentation**: Add references to original CARS algorithm

### 2. Test Coverage Expansion

**Current Coverage**: ~26% (15 test files for 57 source files)

**Priority test files to create**:
```
tests/testthat/test-evaluation-models_parallel.R
tests/testthat/test-evaluation-chunk_configurations.R
tests/testthat/test-covariates-soil-orchestrator.R
tests/testthat/test-covariates-climate-orchestrator.R
tests/testthat/test-stack-build_ensemble.R
tests/testthat/test-visuals-plot_models_radar.R
```

**Testing goals**:
- Achieve 70% minimum coverage
- Add integration tests for complete workflows
- Test error paths and edge cases
- Add performance benchmarks

### 3. File Organization and Naming

#### Files to Rename (consistency)
```
model_build_recipe.R → models-build_recipe.R
model_generate_workflow_ids.R → models-generate_workflow_ids.R
step_join_covariates.R → step-join_covariates.R
step_transform_spectra.R → step-transform_spectra.R
utils_*.R → utils-*.R (all utils files)
```

#### Large Files to Split (>700 lines)
- `visuals-plot_models_radar.R` (947 lines)
- `visuals-plot_component_network_bundling.R` (844 lines)
- `visuals-plot_component_effects_enhanced.R` (796 lines)
- `visuals-plot_component_value_interactions.R` (735 lines)

#### Archive Directory
- Review and delete/integrate 13 files in `archive/`
- Notable: `CopyOfutils_error_handling.R` (version control artifact)

---

## MEDIUM Priority Issues (5-7 days effort)

### 1. Documentation Completion

#### Missing Documentation
- ~30 exported functions lack complete roxygen2 documentation
- Add `@examples` sections to all user-facing functions
- Add `@details` for complex functions
- Include `@seealso` cross-references

#### Vignettes Needed
- Parallel processing guide
- Troubleshooting guide
- Complete workflow examples
- Feature selection comparison

### 2. Memory Management

#### Implement Memory Monitoring
```r
# Add to parallel processing functions
memory_limit <- 8e9  # 8GB limit
if (pryr::mem_used() > memory_limit) {
  gc()
  # Consider chunking or stopping
}
```

#### Optimization Opportunities
- Add explicit `gc()` calls after large operations
- Consider data.table for large data operations
- Optimize matrix operations

### 3. API Consistency and Cleanup

#### Reduce API Surface
- **Current**: 90 exported functions
- **Target**: ~50 core user-facing functions
- Move internal utilities to non-exported

#### Parameter Standardization
```r
# Standardize across all functions:
cv_folds = 5       # not 3 or varying
verbose = TRUE     # not quiet = FALSE
prop_holdout = 0.2 # not prop = 0.95
```

#### Remove Unnecessary Exports
- Internal `_new` constructors
- Helper functions not meant for users
- Development/debugging functions

### 4. Development Artifacts Cleanup

#### Directories to Clean
- `scratch/`: 35+ test files and images → gitignore or move to tests
- `dev/`: Keep documentation, move test scripts to tests/testthat
- `experimental/`: Move to dev/ or archive

#### Binary Files
- `sysdata.rda` in R/: Document purpose or remove
- `.RData` (40MB): Should not be in repository

---

## LOW Priority Improvements (Post-v1.0)

### 1. Performance Optimizations
- Implement adaptive parallel worker allocation
- Benchmark and optimize chunk sizes
- Profile and optimize bottlenecks

### 2. Enhanced Visualization
- Additional plot themes
- Interactive plotly versions
- Export to publication formats

### 3. Advanced Features
- GPU acceleration for large datasets
- Cloud/HPC integration improvements
- Real-time progress monitoring dashboard

### 4. Code Organization
- Consider subdirectory structure (requires special R package handling)
- Create separate development branch for experimental features
- Implement continuous integration testing

---

## Quick Wins Checklist

```bash
# Can be done in < 1 hour:

# 1. Clean all temporary files
rm -f .RDataTmp* .RData .Rhistory .DS_Store

# 2. Fix the namespace typo
sed -i '' 's/li::cli_alert_danger/cli::cli_alert_danger/g' R/model_build_recipe.R

# 3. Update ignore files
cat >> .Rbuildignore << 'EOF'
^scratch$
^dev$
^archive$
^experimental$
^\.RDataTmp.*$
EOF

# 4. Regenerate documentation
Rscript -e "devtools::document()"

# 5. Run package check
R CMD check --no-manual .
```

---

## Implementation Timeline

### Week 1 (Critical + High Priority)
- Day 1: Clean files, fix typo, update .Rbuildignore
- Day 2: Fix SHAP implementation
- Day 3-4: Update CV folds and holdout proportions
- Day 5: Begin test suite expansion

### Week 2 (High + Medium Priority)
- Day 1-2: Complete test coverage to 70%
- Day 3: File renaming and organization
- Day 4: Documentation completion
- Day 5: Memory management implementation

### Week 3 (Medium Priority + Polish)
- Day 1-2: API consistency cleanup
- Day 3: Vignette creation
- Day 4: Integration testing
- Day 5: Final checks and documentation

---

## Success Metrics for v1.0

- [ ] No CRITICAL issues remaining
- [ ] Test coverage ≥ 70%
- [ ] All exported functions documented
- [ ] R CMD check passes with 0 errors, 0 warnings
- [ ] CV folds ≥ 5 everywhere
- [ ] Holdout ≥ 15%
- [ ] Memory usage stays under 8GB for standard workflows
- [ ] Archive folder removed or integrated
- [ ] Consistent file naming throughout

---

## Notes

- Package shows good modular design with clear prefix-based organization
- Core functionality is solid and working
- Most issues are about polish and best practices rather than fundamental problems
- The parallel processing implementation is particularly well done
- Consider submitting to CRAN after addressing CRITICAL and HIGH priority items

---

*Last Updated: 2025-08-22*  
*Package Version: 0.7.5*  
*Total Effort Estimate: 2-3 weeks for complete v1.0 readiness*